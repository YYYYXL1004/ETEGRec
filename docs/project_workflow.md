# ETEGRec 项目整体流程文档

## 1. 项目概述

ETEGRec 是一个端到端的生成式推荐系统，它将项目标记化和生成式推荐统一到一个框架中。项目包含两个主要组件：RQ-VAE（用于项目标记化）和推荐模型（用于生成推荐）。

## 2. 整体流程

项目的整体流程可以分为三个主要阶段：

1. **数据准备**
2. **RQ-VAE 训练**
3. **推荐模型训练与评估**

## 3. 详细流程说明

### 3.1 数据准备

数据准备阶段主要在 `data.py` 文件中实现。

#### 3.1.1 数据加载
- 使用 `load_split_data(config)` 函数加载训练、验证和测试数据。
- 数据文件格式为 JSONL，包含用户交互历史和目标项目。
- 项目 ID 被映射到连续的整数 ID。

#### 3.1.2 数据集构建
- `SequentialSplitDataset` 类用于构建序列分割数据集。
- 将用户交互序列分割为输入序列和目标项目。
- `Collator` 类用于批处理数据，包括填充序列和创建注意力掩码。

### 3.2 RQ-VAE 训练

RQ-VAE 训练在 `RQVAE/` 目录下实现。

#### 3.2.1 数据准备
- 使用 `EmbDataset` 类加载预训练的项目嵌入（如 LLaMA2 嵌入）。
- 嵌入文件通常为 `.npy` 格式。

#### 3.2.2 模型结构
- `RQVAE` 模型包含编码器、残差向量量化器（ResidualVectorQuantizer）和解码器。
- 编码器和解码器使用 MLP 层实现。
- 残差向量量化器包含多个向量量化层。

#### 3.2.3 训练过程
- 使用 `Trainer` 类进行训练。
- 损失函数包括重构损失和量化损失。
- 支持不同的距离度量（L2、点积、余弦）和损失类型（MSE、L1、对比损失）。
- 训练脚本: `RQVAE/main.py`
- 运行命令: `cd RQVAE && bash run_pretrain.sh`

### 3.3 推荐模型训练与评估

推荐模型的训练和评估在项目根目录下实现。

#### 3.3.1 模型结构
- 推荐模型基于 T5 架构实现。
- `Model` 类封装了 T5 模型，并添加了项目嵌入和适配器层。
- 使用 RQ-VAE 学习的语义 ID 作为输入和输出。

#### 3.3.2 训练过程
- 使用 `Trainer` 类进行训练。
- 训练分为两个阶段：交替优化 RQ-VAE 和推荐模型。
- 损失函数包括代码预测损失、KL 散度损失和对比损失。
- 支持分布式训练（DDP）。

#### 3.3.3 评估过程
- 使用 `Trainer._test_epoch` 方法进行评估。
- 评估指标包括 Recall@K 和 NDCG@K。
- 生成推荐时使用束搜索（beam search）算法。

#### 3.3.4 训练脚本
- 主训练脚本: `main.py`
- 运行命令: `bash run.sh`

## 4. 项目执行顺序

1. 准备项目嵌入数据（用于 RQ-VAE 训练）
2. 训练 RQ-VAE 模型：
   ```bash
   cd RQVAE
   bash run_pretrain.sh
   ```
3. 准备推荐系统训练数据
4. 训练和评估推荐模型：
   ```bash
   bash run.sh
   ```

## 5. 关键组件

- **RQ-VAE**: 负责将项目嵌入转换为语义 ID
- **推荐模型**: 基于 T5 的生成式推荐模型
- **Trainer**: 训练和评估逻辑
- **数据处理**: 数据加载和预处理

## 6. 输出文件

- RQ-VAE 模型权重
- 推荐模型权重
- 训练日志
- 评估结果